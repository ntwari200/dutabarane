<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Admin Dashboard</title>

<style>
*{box-sizing:border-box;font-family:Arial;}
body{margin:0;background:#0b0b0b;color:white;}
h1,h2{color:#ff2b2b;text-align:center;}
.container{
    max-width:1200px;
    margin:auto;
    padding:15px;
    display:flex;
    flex-wrap:wrap;
    gap:20px;
}
.left-section{
    flex:1 1 40%;
    display:flex;
    flex-direction:column;
    gap:20px;
}
.right-section{
    flex:1 1 55%;
    display:flex;
    flex-direction:column;
    gap:20px;
}
.card{
    background:#141414;
    border:2px solid #ff2b2b;
    border-radius:10px;
    padding:15px;
    box-shadow:0 0 15px rgba(255,0,0,.4);
}
input,button{
    padding:10px;
    margin:5px 0;
    width:100%;
    background:#000;
    border:2px solid #ff2b2b;
    color:white;
    border-radius:6px;
}
button{
    background:#ff2b2b;
    font-weight:bold;
    cursor:pointer;
}
button:hover{background:#ff5555;}
.table-box{
    overflow:auto;
    max-height:300px;
}
table{
    width:100%;
    border-collapse:collapse;
    min-width:400px;
}
th,td{
    border:1px solid #ff2b2b;
    padding:8px;
}
th{
    background:#ff2b2b;
    color:black;
    position:sticky;
    top:0;
}
.search{
    margin-bottom:10px;
}
#fileList{
    list-style:none;
    padding:0;
}
#fileList li{
    padding:10px;
    margin:5px 0;
    border:1px solid #ff2b2b;
    border-radius:5px;
    cursor:pointer;
}
#fileList li:hover{
    background:#ff2b2b;
    color:black;
}
/* Hide/Show toggle button */
.toggle-btn{
    cursor:pointer;
    color:red;
    font-weight:bold;
    margin-bottom:5px;
}
/* Popup viewer */
.popup{
    position:fixed;
    top:50px;
    left:50%;
    transform:translateX(-50%);
    background:#141414;
    border:2px solid #ff2b2b;
    border-radius:10px;
    padding:15px;
    box-shadow:0 0 25px rgba(255,0,0,.6);
    z-index:200;
    max-width:90%;
    display:none;
}
.popup-header{
    display:flex;
    justify-content:space-between;
    align-items:center;
    margin-bottom:10px;
}
.popup-header span{
    cursor:pointer;
    font-weight:bold;
    color:red;
}
.popup-body{
    max-height:300px;
    overflow:auto;
}
.popup.minimized{
    height:40px;
    overflow:hidden;
}
@media(max-width:768px){
    .container{flex-direction:column;}
    .left-section,.right-section{flex:1 1 100%;}
    .popup{width:95% !important; left:50% !important; transform:translateX(-50%) !important;}
}
</style>
</head>

<body>

<div class="container">

<h1 style="flex-basis:100%">ADMIN CONTROL PANEL</h1>

<!-- LEFT SECTION: MEMBERS -->
<div class="left-section">
    <div class="card">
        <h2>System Management (Members) <span class="toggle-btn" onclick="toggleMembers(this)">&#9660;</span></h2>
        <div id="memberContent">
            <input class="search" placeholder="Search member..." onkeyup="searchMembers(this.value)">
            <form id="memberForm">
                <input id="mName" placeholder="Member Name" required>
                <input id="mPhone" placeholder="Phone Number" required>
                <button>Add Member</button>
            </form>
        </div>
    </div>
    <div class="card">
        <div class="table-box">
            <table>
                <thead><tr><th>Name</th><th>Phone</th></tr></thead>
                <tbody id="members"></tbody>
            </table>
        </div>
    </div>
</div>

<!-- RIGHT SECTION: FILES -->
<div class="right-section">
    <div class="card">
        <h2>Files</h2>
        <input class="search" placeholder="Search file..." onkeyup="searchFiles(this.value)">
        <form id="fileForm">
            <input id="fileName" placeholder="File Name" required>
            <button>Create File</button>
        </form>
        <ul id="fileList"></ul>
    </div>
</div>

<!-- FILE VIEW POPUP -->
<div class="popup" id="fileViewer">
    <div class="popup-header">
        <h2 id="currentFile"></h2>
        <div>
            <span onclick="togglePopup()">&#9650;</span>
            <span onclick="closePopup()">X</span>
        </div>
    </div>
    <div class="popup-body">
        <div class="table-box">
            <table>
                <thead><tr><th>Member</th><th>Amount Deposited</th></tr></thead>
                <tbody id="fileTable"></tbody>
            </table>
        </div>
        <button onclick="saveFile()">Save File</button>
        <button onclick="deleteFile()" style="background:black;color:red">Delete File</button>
    </div>
</div>

</div>

<script>
const BASE="/api/";
let currentFileId=null;
let members=[];

/* ================= MEMBERS ================= */
async function loadMembers(){
    const r = await fetch(BASE+"members");
    members = await r.json();
    renderMembers(members);
}
function renderMembers(data){
    document.getElementById("members").innerHTML =
    data.map(m=>`<tr><td>${m.name}</td><td>${m.phone}</td></tr>`).join("");
}
function searchMembers(v){
    renderMembers(members.filter(m=>m.name.toLowerCase().includes(v.toLowerCase())));
}
memberForm.onsubmit = async e=>{
    e.preventDefault();
    await fetch(BASE+"members",{
        method:"POST",
        headers:{'Content-Type':'application/json'},
        body:JSON.stringify({name:mName.value,phone:mPhone.value})
    });
    e.target.reset();
    loadMembers();
};
/* Toggle members section */
function toggleMembers(el){
    const content=document.getElementById("memberContent");
    if(content.style.display==="none"){
        content.style.display="block";
        el.innerHTML="&#9660;";
    }else{
        content.style.display="none";
        el.innerHTML="&#9654;";
    }
}

/* ================= FILES ================= */
async function loadFiles(){
    const r = await fetch(BASE+"files");
    const files = await r.json();
    fileList.innerHTML = files.map(f =>
        `<li onclick="openFile(${f.id}, '${f.name.replace(/'/g,"")}')">${f.name}</li>`
    ).join("");
}
function searchFiles(v){
    [...fileList.children].forEach(li=>{
        li.style.display = li.innerText.toLowerCase().includes(v.toLowerCase()) ? "" : "none";
    });
}
fileForm.onsubmit = async e=>{
    e.preventDefault();
    const res = await fetch(BASE+"files",{
        method:"POST",
        headers:{'Content-Type':'application/json'},
        body:JSON.stringify({name:fileName.value})
    });
    if(!res.ok) alert("File creation failed");
    e.target.reset();
    loadFiles();
};

/* ================= FILE VIEW POPUP ================= */
async function openFile(id,name){
    currentFileId = id;
    const popup = document.getElementById("fileViewer");
    popup.style.display="block";
    popup.classList.remove("minimized");
    document.getElementById("currentFile").innerText = name;

    const r = await fetch(BASE+"files/"+id);
    const data = await r.json();

    fileTable.innerHTML = members.map(m=>`
        <tr>
            <td>${m.name}</td>
            <td><input value="${data[m.id]||''}"></td>
        </tr>
    `).join("");
}
function togglePopup(){
    const popup=document.getElementById("fileViewer");
    popup.classList.toggle("minimized");
}
function closePopup(){
    document.getElementById("fileViewer").style.display="none";
}

async function saveFile(){
    const payload = {};
    [...fileTable.querySelectorAll("tr")].forEach((tr,i)=>{
        payload[members[i].id] = tr.querySelector("input").value;
    });
    await fetch(BASE+"files/"+currentFileId,{
        method:"PUT",
        headers:{'Content-Type':'application/json'},
        body:JSON.stringify(payload)
    });
    alert("File saved successfully");
}
async function deleteFile(){
    if(!confirm("Delete this file?")) return;
    await fetch(BASE+"files/"+currentFileId,{method:"DELETE"});
    closePopup();
    loadFiles();
}

loadMembers();
loadFiles();
</script>

</body>
</html>

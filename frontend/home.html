<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Admin Dashboard</title>

<style>
*{box-sizing:border-box;font-family:Arial;}
body{margin:0;background:#0b0b0b;color:white;}
h1,h2{color:#ff2b2b;text-align:center;}
.container{
    max-width:1200px;
    margin:auto;
    padding:15px;
    display:flex;
    flex-wrap:wrap;
    gap:20px;
}
.left-section{
    flex:1 1 40%;
    display:flex;
    flex-direction:column;
    gap:20px;
}
.right-section{
    flex:1 1 55%;
    display:flex;
    flex-direction:column;
    gap:20px;
}
.card{
    background:#141414;
    border:2px solid #ff2b2b;
    border-radius:10px;
    padding:15px;
    box-shadow:0 0 15px rgba(255,0,0,.4);
}
input,button{
    padding:10px;
    margin:5px 0;
    width:100%;
    background:#000;
    border:2px solid #ff2b2b;
    color:white;
    border-radius:6px;
}
input.changed{border-color:red;}
input.low{background:yellow;color:black;}
input.high{background:green;color:black;}
input.invalid{background:red;color:black;}
button{
    background:#ff2b2b;
    font-weight:bold;
    cursor:pointer;
}
button:hover{background:#ff5555;}
.table-box{
    overflow:auto;
    max-height:300px;
}
table{
    width:100%;
    border-collapse:collapse;
    min-width:400px;
}
th,td{
    border:1px solid #ff2b2b;
    padding:8px;
}
th{
    background:#ff2b2b;
    color:black;
    position:sticky;
    top:0;
}
.search{margin-bottom:10px;}
#fileList{
    list-style:none;
    padding:0;
}
#fileList li{
    padding:10px;
    margin:5px 0;
    border:1px solid #ff2b2b;
    border-radius:5px;
    cursor:pointer;
}
#fileList li:hover{background:#ff2b2b;color:black;}
.toggle-btn{cursor:pointer;color:red;font-weight:bold;margin-left:10px;}
.popup{
    position:fixed;
    top:50px;
    left:50%;
    transform:translateX(-50%);
    background:#141414;
    border:2px solid #ff2b2b;
    border-radius:10px;
    padding:15px;
    box-shadow:0 0 25px rgba(255,0,0,.6);
    z-index:200;
    max-width:90%;
    display:none;
    cursor:default;
    transition: all 0.3s ease;
    min-width:300px;
}
.popup-header{
    display:flex;
    justify-content:space-between;
    align-items:center;
    margin-bottom:10px;
    cursor:move;
}
.popup-header span{
    cursor:pointer;
    font-weight:bold;
    color:red;
    margin-left:5px;
}
.popup-body{
    max-height:60vh;
    overflow:auto;
    transition: all 0.3s ease;
}
.popup.minimized{height:40px;overflow:hidden;}
.popup.maximized{
    top:0;left:0;transform:none;
    width:100%;height:100%;border-radius:0;padding:20px;
}
.delete-btn{
    background:black;color:red;font-weight:bold;padding:5px 10px;border-radius:5px;cursor:pointer;
}
.delete-btn:hover{background:red;color:black;}
#membersTableContainer.minimized{
    max-height:0;
    overflow:hidden;
    transition:0.3s;
}
.total-amount{
    margin-top:10px;
    font-weight:bold;
    font-size:1.1rem;
    text-align:right;
    color:#ff2b2b;
}
@media(max-width:768px){
    .container{flex-direction:column;}
    .left-section,.right-section{flex:1 1 100%;}
    .popup{width:95% !important; left:50% !important; transform:translateX(-50%) !important;}
}
</style>
</head>
<body>

<div class="container">
<h1 style="flex-basis:100%">ADMIN CONTROL PANEL</h1>

<!-- LEFT SECTION: MEMBERS -->
<div class="left-section">
    <div class="card">
        <h2>System Management (Members)
            <span class="toggle-btn" onclick="toggleMembers(this)">&#9660;</span>
        </h2>
        <div id="memberContent">
            <input class="search" placeholder="Search member..." onkeyup="searchMembers(this.value)">
            <form id="memberForm">
                <input id="mName" placeholder="Member Name" required>
                <input id="mPhone" placeholder="Phone Number" required>
                <button>Add Member</button>
            </form>
        </div>
    </div>
    <div class="card" id="membersTableContainer">
        <div class="table-box">
            <table>
                <thead><tr><th>Name</th><th>Phone</th><th>Delete</th></tr></thead>
                <tbody id="members"></tbody>
            </table>
        </div>
    </div>
</div>

<!-- RIGHT SECTION: FILES -->
<div class="right-section">
    <div class="card">
        <h2>Files</h2>
        <input class="search" placeholder="Search file..." onkeyup="searchFiles(this.value)">
        <form id="fileForm">
            <input id="fileName" placeholder="File Name" required>
            <button>Create File</button>
        </form>
        <ul id="fileList"></ul>
    </div>
</div>

<!-- FILE VIEW POPUP -->
<div class="popup" id="fileViewer">
    <div class="popup-header" id="popupHeader">
        <h2 id="currentFile"></h2>
        <div>
            <span onclick="togglePopup()">&#9650;</span>
            <span onclick="toggleMaximize()">&#9744;</span>
            <span onclick="closePopup()">X</span>
        </div>
    </div>
    <div class="popup-body">
        <div class="table-box">
            <table>
                <thead><tr><th>Member</th><th>Amount Deposited</th></tr></thead>
                <tbody id="fileTable"></tbody>
            </table>
        </div>
        <div class="total-amount">Total: <span id="totalAmount">0</span></div>
        <button onclick="saveFile()">Save File</button>
        <button onclick="deleteFile()" style="background:black;color:red">Delete File</button>
    </div>
</div>

</div>

<script>
const BASE="/api/";
let currentFileId=null;
let members=[];

/* ================= MEMBERS ================= */
async function loadMembers(){
    const r = await fetch(BASE+"members");
    members = await r.json();
    renderMembers(members);
}
function renderMembers(data, highlight=""){
    const regex = new RegExp(`(${highlight})`, "ig");
    document.getElementById("members").innerHTML =
    data.map(m=>`<tr>
        <td>${highlight ? m.name.replace(regex,'<span class="highlight">$1</span>') : m.name}</td>
        <td>${highlight ? m.phone.replace(regex,'<span class="highlight">$1</span>') : m.phone}</td>
        <td><button class="delete-btn" onclick="deleteMember(${m.id})">Delete</button></td>
    </tr>`).join("");
}
function searchMembers(v){ renderMembers(members,v); }
memberForm.onsubmit = async e=>{
    e.preventDefault();
    const res = await fetch(BASE+"members",{
        method:"POST",
        headers:{'Content-Type':'application/json'},
        body:JSON.stringify({name:mName.value,phone:mPhone.value})
    });
    if(!res.ok){ alert("Failed to add member"); return; }
    const newMember = await res.json();
    members.push(newMember);
    renderMembers(members);
    if(currentFileId){
        const row = document.createElement("tr");
        row.innerHTML = `<td>${newMember.name}</td><td><input value="" oninput="updateInputColor(this);updateTotal();"></td>`;
        fileTable.appendChild(row);
    }
    e.target.reset();
};
function toggleMembers(el){
    const container=document.getElementById("membersTableContainer");
    container.classList.toggle("minimized");
    el.innerHTML = container.classList.contains("minimized") ? "&#9654;" : "&#9660;";
}
async function deleteMember(id){
    if(!confirm("Delete this member?")) return;
    await fetch(BASE+"members/"+id,{method:"DELETE"});
    const rFiles = await fetch(BASE+"files");
    const files = await rFiles.json();
    for(const f of files){
        const fileDataResp = await fetch(BASE+"files/"+f.id);
        const fileData = await fileDataResp.json();
        if(fileData[id] !== undefined){
            delete fileData[id];
            await fetch(BASE+"files/"+f.id,{
                method:"PUT",
                headers:{'Content-Type':'application/json'},
                body:JSON.stringify(fileData)
            });
        }
    }
    loadMembers();
    if(currentFileId){
        openFile(currentFileId, document.getElementById("currentFile").innerText);
    }
}

/* ================= FILES ================= */
async function loadFiles(){
    const r = await fetch(BASE+"files");
    const files = await r.json();
    fileList.innerHTML = files.map(f => `<li onclick="openFile(${f.id}, '${f.name.replace(/'/g,"")}')">${f.name}</li>`).join("");
    searchFiles(document.querySelector("#fileForm ~ .search").value);
}
function searchFiles(v){
    const regex = new RegExp(`(${v})`,"ig");
    [...fileList.children].forEach(li=>{
        li.style.display = li.innerText.toLowerCase().includes(v.toLowerCase()) ? "" : "none";
        li.innerHTML = v ? li.innerText.replace(regex,'<span class="highlight">$1</span>') : li.innerText;
    });
}
fileForm.onsubmit = async e=>{
    e.preventDefault();
    const res = await fetch(BASE+"files",{
        method:"POST",
        headers:{'Content-Type':'application/json'},
        body:JSON.stringify({name:fileName.value})
    });
    if(!res.ok) alert("File creation failed");
    e.target.reset();
    loadFiles();
};

/* ================= FILE VIEW POPUP ================= */
async function openFile(id,name){
    currentFileId = id;
    const popup = document.getElementById("fileViewer");
    popup.style.display="block";
    popup.classList.remove("minimized","maximized");
    document.getElementById("currentFile").innerText = name;

    const r = await fetch(BASE+"files/"+id);
    const data = await r.json();

    fileTable.innerHTML = members.map(m=>`
        <tr>
            <td>${m.name}</td>
            <td><input value="${data[m.id]||''}" oninput="updateInputColor(this);updateTotal();"></td>
        </tr>
    `).join("");

    [...fileTable.querySelectorAll("input")].forEach(input => updateInputColor(input));
    updateTotal();
}

function updateInputColor(input){
    const val = parseFloat(input.value);
    input.classList.remove("low","high","invalid","changed");
    if(input.value.trim()===""){return;}
    if(isNaN(val)){input.classList.add("invalid");}
    else if(val<=50){input.classList.add("low");}
    else if(val>50){input.classList.add("high");}
    input.classList.add("changed");
}

function updateTotal(){
    let total = 0;
    [...fileTable.querySelectorAll("input")].forEach(input=>{
        const val=parseFloat(input.value);
        if(!isNaN(val)) total += val;
    });
    document.getElementById("totalAmount").innerText = total.toFixed(2);
}

function togglePopup(){
    const popup=document.getElementById("fileViewer");
    popup.classList.toggle("minimized");
}
function toggleMaximize(){
    const popup=document.getElementById("fileViewer");
    popup.classList.toggle("maximized");
}
function closePopup(){
    document.getElementById("fileViewer").style.display="none";
}

async function saveFile(){
    const payload = {};
    [...fileTable.querySelectorAll("tr")].forEach((tr,i)=>{
        payload[members[i].id] = tr.querySelector("input").value;
        tr.querySelector("input").classList.remove("changed");
    });
    await fetch(BASE+"files/"+currentFileId,{
        method:"PUT",
        headers:{'Content-Type':'application/json'},
        body:JSON.stringify(payload)
    });
    alert("File saved successfully");
    updateTotal();
}
async function deleteFile(){
    if(!confirm("Delete this file?")) return;
    await fetch(BASE+"files/"+currentFileId,{method:"DELETE"});
    closePopup();
    loadFiles();
}

/* ================= DRAGGABLE POPUP ================= */
const popup = document.getElementById("fileViewer");
const header = document.getElementById("popupHeader");
let offsetX=0, offsetY=0, isDragging=false;

header.addEventListener("mousedown", startDrag);
header.addEventListener("touchstart", startDrag, {passive:false});

function startDrag(e){
    isDragging = true;
    const rect = popup.getBoundingClientRect();
    if(e.type==="mousedown"){
        offsetX = e.clientX - rect.left;
        offsetY = e.clientY - rect.top;
        document.addEventListener("mousemove", drag);
        document.addEventListener("mouseup", stopDrag);
    } else {
        offsetX = e.touches[0].clientX - rect.left;
        offsetY = e.touches[0].clientY - rect.top;
        document.addEventListener("touchmove", drag);
        document.addEventListener("touchend", stopDrag);
    }
    e.preventDefault();
}

function drag(e){
    if(!isDragging) return;
    let x,y;
    if(e.type==="mousemove"){x = e.clientX - offsetX; y = e.clientY - offsetY;}
    else{x = e.touches[0].clientX - offsetX; y = e.touches[0].clientY - offsetY;}
    popup.style.left = x + "px";
    popup.style.top = y + "px";
    popup.style.transform = "none";
}

function stopDrag(){
    isDragging=false;
    document.removeEventListener("mousemove", drag);
    document.removeEventListener("mouseup", stopDrag);
    document.removeEventListener("touchmove", drag);
    document.removeEventListener("touchend", stopDrag);
}

loadMembers();
loadFiles();
</script>

</body>
</html>

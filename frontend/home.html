<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Admin Dashboard</title>

<style>
*{box-sizing:border-box;font-family:Arial}
body{margin:0;background:#0b0b0b;color:white}

/* ===== TITLES ===== */
h1,h2{color:#ff2b2b;text-align:center}

/* ===== LAYOUT ===== */
.container{
  max-width:1300px;
  margin:auto;
  padding:15px;
  display:flex;
  flex-wrap:wrap;
  gap:20px;
}
.left{flex:1 1 40%}
.right{flex:1 1 55%}

/* ===== CARDS ===== */
.card{
  background:#141414;
  border:2px solid #ff2b2b;
  border-radius:12px;
  padding:15px;
  box-shadow:0 0 15px rgba(255,0,0,.4);
}

/* ===== INPUTS ===== */
input,button{
  width:100%;
  padding:10px;
  margin:5px 0;
  border-radius:6px;
  border:2px solid #ff2b2b;
  background:black;
  color:white;
}
button{background:#ff2b2b;font-weight:bold;cursor:pointer}
button:hover{background:#ff5555}

/* ===== TABLE ===== */
.table-box{overflow:auto;max-height:320px}
table{width:100%;border-collapse:collapse;min-width:500px}
th,td{border:1px solid #ff2b2b;padding:8px}
th{background:#ff2b2b;color:black;position:sticky;top:0}

/* ===== COLORS ===== */
.amount{color:#00ff88;font-weight:bold}
.loan{color:#ffaa00;font-weight:bold}

/* ===== FILE LIST ===== */
#fileList li{
  list-style:none;
  padding:10px;
  border:1px solid #ff2b2b;
  border-radius:6px;
  margin:5px 0;
  cursor:pointer;
}
#fileList li:hover{background:#ff2b2b;color:black}

/* ===== POPUP ===== */
.popup{
  position:fixed;
  top:70px;left:70px;
  width:520px;
  max-width:95%;
  background:#111;
  border:2px solid #ff2b2b;
  border-radius:12px;
  display:none;
  z-index:1000;
  animation:pop .3s ease;
}
@keyframes pop{from{transform:scale(.8);opacity:0}to{transform:scale(1);opacity:1}}

.popup.max{
  top:5%;left:5%;
  width:90%;height:90%;
}
.popup-header{
  background:#ff2b2b;
  color:black;
  padding:8px;
  display:flex;
  justify-content:space-between;
  cursor:move;
}
.popup-body{
  padding:10px;
  overflow:auto;
  max-height:70vh;
}

/* ===== MOBILE ===== */
@media(max-width:768px){
  .container{flex-direction:column}
}
</style>
</head>

<body>

<div class="container">
<h1 style="flex-basis:100%">ADMIN PANEL</h1>

<!-- MEMBERS -->
<div class="left card">
<h2>Members</h2>
<form id="memberForm">
<input id="mName" placeholder="Name" required>
<input id="mPhone" placeholder="Phone" required>
<button>Add Member</button>
</form>

<div class="table-box">
<table>
<thead><tr><th>Name</th><th>Phone</th><th>‚ùå</th></tr></thead>
<tbody id="members"></tbody>
</table>
</div>
</div>

<!-- FILES -->
<div class="right card">
<h2>Files</h2>
<form id="fileForm">
<input id="fileName" placeholder="File name" required>
<button>Create File</button>
</form>
<ul id="fileList"></ul>
</div>
</div>

<!-- FILE VIEWER -->
<div class="popup" id="popup">
<div class="popup-header" id="drag">
<b id="fileTitle"></b>
<div>
<span onclick="popup.classList.toggle('max')">‚¨ú</span>
<span onclick="popup.style.display='none'">‚ùå</span>
</div>
</div>

<div class="popup-body">
<input placeholder="Search member..." onkeyup="filterFile(this.value)">
<table>
<thead><tr><th>Member</th><th>Amount</th><th>Loan</th></tr></thead>
<tbody id="fileTable"></tbody>
</table>
<button onclick="saveFile()">üíæ Save</button>
</div>
</div>

<script>
const API="/api/";
let members=[],files=[],currentFile=null;

/* ===== MEMBERS ===== */
async function loadMembers(){
  const r=await fetch(API+"members");
  members=await r.json();
  membersBox.innerHTML=members.map(m=>`
    <tr>
      <td>${m.name}</td>
      <td>${m.phone}</td>
      <td><button onclick="delMember('${m.id}')">X</button></td>
    </tr>`).join("");
}
async function delMember(id){
  if(!confirm("Delete member?"))return;
  await fetch(API+"members/"+id,{method:"DELETE"});
  loadMembers(); loadFiles();
}

/* ===== FILES ===== */
async function loadFiles(){
  const r=await fetch(API+"files");
  files=await r.json();
  fileList.innerHTML=files.map(f=>`
    <li onclick="openFile('${f.id}','${f.name}')">${f.name}</li>`).join("");
}

/* ===== OPEN FILE ===== */
async function openFile(id,name){
  currentFile=id;
  fileTitle.innerText=name;
  popup.style.display="block";

  const r=await fetch(API+"files/"+id);
  const data=await r.json();

  fileTable.innerHTML=members.map(m=>`
    <tr>
      <td>${m.name}</td>
      <td><input class="amount" value="${data[m.id]?.amount||0}"></td>
      <td><input class="loan" value="${data[m.id]?.loan||0}"></td>
    </tr>`).join("");
}

/* ===== SAVE FILE ===== */
async function saveFile(){
  const payload={};
  [...fileTable.rows].forEach((r,i)=>{
    payload[members[i].id]={
      amount:r.cells[1].querySelector("input").value,
      loan:r.cells[2].querySelector("input").value
    };
  });

  await fetch(API+"files/"+currentFile,{
    method:"PUT",
    headers:{'Content-Type':'application/json'},
    body:JSON.stringify(payload)
  });
  alert("Saved successfully");
}

/* ===== FILTER ===== */
function filterFile(v){
  [...fileTable.rows].forEach(r=>{
    r.style.display=r.cells[0].innerText.toLowerCase().includes(v.toLowerCase())?"":"none";
  });
}

/* ===== DRAG ===== */
let dx,dy,drag=false;
drag.onmousedown=e=>{drag=true;dx=e.clientX-popup.offsetLeft;dy=e.clientY-popup.offsetTop};
document.onmousemove=e=>drag&&(popup.style.left=e.clientX-dx+"px",popup.style.top=e.clientY-dy+"px");
document.onmouseup=()=>drag=false;

/* ===== FORMS ===== */
memberForm.onsubmit=e=>{
  e.preventDefault();
  fetch(API+"members",{method:"POST",headers:{'Content-Type':'application/json'},
  body:JSON.stringify({name:mName.value,phone:mPhone.value})})
  .then(()=>{memberForm.reset();loadMembers();loadFiles()});
};

fileForm.onsubmit=e=>{
  e.preventDefault();
  fetch(API+"files",{method:"POST",headers:{'Content-Type':'application/json'},
  body:JSON.stringify({name:fileName.value})})
  .then(()=>{fileForm.reset();loadFiles()});
};

loadMembers();
loadFiles();
</script>
</body>
</html>

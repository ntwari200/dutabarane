<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Admin Dashboard</title>
<style>
*{box-sizing:border-box;font-family:Arial}
body{margin:0;background:#0b0b0b;color:white;}

/* ================= LAYOUT ================= */
h1,h2{color:#ff2b2b;text-align:center;}
.container{max-width:1200px;margin:auto;padding:15px;display:flex;flex-wrap:wrap;gap:20px;}
.left-section{flex:1 1 40%;display:flex;flex-direction:column;gap:20px;}
.right-section{flex:1 1 55%;display:flex;flex-direction:column;gap:20px;}

/* ================= CARDS ================= */
.card{background:#141414;border:2px solid #ff2b2b;border-radius:10px;padding:15px;box-shadow:0 0 15px rgba(255,0,0,.4);transition:0.3s;}
.card.fade{animation:fadeIn 0.5s;}
@keyframes fadeIn{0%{opacity:0}100%{opacity:1}}

/* ================= INPUTS ================= */
input,button{padding:10px;margin:5px 0;width:100%;background:#000;border:2px solid #ff2b2b;color:white;border-radius:6px;}
button{background:#ff2b2b;font-weight:bold;cursor:pointer;transition:0.2s;}
button:hover{background:#ff5555}

/* ================= TABLE ================= */
.table-box{overflow:auto;max-height:300px;}
table{width:100%;border-collapse:collapse;min-width:400px;}
th,td{border:1px solid #ff2b2b;padding:8px;}
th{background:#ff2b2b;color:black;position:sticky;top:0;}
.search{margin-bottom:10px;}
#fileList{list-style:none;padding:0;margin:0;}
#fileList li{padding:10px;margin:5px 0;border:1px solid #ff2b2b;border-radius:5px;cursor:pointer;transition:0.2s;}
#fileList li:hover{background:#ff2b2b;color:black}

/* ================= POPUP ================= */
.popup{position:fixed;top:80px;left:80px;width:500px;max-width:95%;background:#111;border:2px solid #ff2b2b;border-radius:10px;display:none;z-index:1000;box-shadow:0 0 25px rgba(255,0,0,.6);transition:0.3s;}
.popup.max{top:5%;left:5%;width:90%;height:90%;}
.popup-header{background:#ff2b2b;color:black;padding:8px;display:flex;justify-content:space-between;cursor:move;}
.popup-header span{cursor:pointer;font-weight:bold;padding:0 6px}
.popup-body{padding:10px;max-height:400px;overflow:auto;}

/* ================= UNDO ================= */
.undo-box{background:#000;border:1px solid #ff2b2b;padding:8px;margin-top:5px;text-align:center;animation:fadeIn 0.5s;}

/* ================= MOBILE ================= */
@media(max-width:768px){
    .container{flex-direction:column}
    .left-section,.right-section{flex:1 1 100%}
}
</style>
</head>
<body>

<div class="container">
<h1 style="flex-basis:100%">ADMIN CONTROL PANEL</h1>

<!-- ================= MEMBERS ================= -->
<div class="left-section">
<div class="card fade">
<h2>Members</h2>
<input class="search" placeholder="Search members..." onkeyup="searchMembers(this.value)">
<form id="memberForm">
<input id="mName" placeholder="Name" required>
<input id="mPhone" placeholder="Phone" required>
<button>Add Member</button>
</form>
<div id="undoArea"></div>
</div>

<div class="card fade">
<div class="table-box">
<table>
<thead><tr><th>Name</th><th>Phone</th><th>❌</th></tr></thead>
<tbody id="members"></tbody>
</table>
</div>
</div>
</div>

<!-- ================= FILES ================= -->
<div class="right-section">
<div class="card fade">
<h2>Files</h2>
<input class="search" placeholder="Search files..." onkeyup="searchFiles(this.value)">
<form id="fileForm">
<input id="fileName" placeholder="File name" required>
<button>Create File</button>
</form>
<ul id="fileList"></ul>
</div>
</div>

<!-- ================= FILE POPUP ================= -->
<div class="popup" id="filePopup">
<div class="popup-header" id="popupHeader">
<b id="currentFile"></b>
<div>
<span onclick="minPopup()">➖</span>
<span onclick="maxPopup()">⬜</span>
<span onclick="closePopup()">❌</span>
</div>
</div>
<div class="popup-body">
<table>
<thead><tr><th>Member</th><th>Loan / Amount</th></tr></thead>
<tbody id="fileTable"></tbody>
</table>
<button onclick="saveFile()">Save</button>
<button onclick="deleteFile()" style="background:black;color:red">Delete File</button>
</div>
</div>

<script>
const BASE="/api/";
let members=[],files=[],currentFileId=null,lastDeleted=null;
const undoArea=document.getElementById("undoArea");

/* ================= MEMBERS ================= */
async function loadMembers(){
    const r=await fetch(BASE+"members");
    members=await r.json();
    renderMembers(members);
}
function renderMembers(data){
    const membersBody=document.getElementById("members");
    membersBody.innerHTML=data.map(m=>`
        <tr class="fade">
            <td>${m.name}</td>
            <td>${m.phone}</td>
            <td><button onclick="deleteMember(${m.id})">X</button></td>
        </tr>
    `).join("");
}
function searchMembers(v){
    renderMembers(members.filter(m=>m.name.toLowerCase().includes(v.toLowerCase())));
}
async function deleteMember(id){
    lastDeleted=members.find(m=>m.id===id);
    await fetch(BASE+"members/"+id,{method:"DELETE"});
    members=members.filter(m=>m.id!==id);
    renderMembers(members);
    showUndo();
}
function showUndo(){
    undoArea.innerHTML=`<div class="undo-box">Member deleted <button onclick="undoDelete()">UNDO</button></div>`;
    setTimeout(()=>undoArea.innerHTML="",7000);
}
async function undoDelete(){
    if(!lastDeleted)return;
    await fetch(BASE+"members",{
        method:"POST",
        headers:{'Content-Type':'application/json'},
        body:JSON.stringify(lastDeleted)
    });
    loadMembers();
    undoArea.innerHTML="";
}

/* ================= FILES ================= */
async function loadFiles(){
    const r=await fetch(BASE+"files");
    files=await r.json();
    const fileList=document.getElementById("fileList");
    fileList.innerHTML=files.map(f=>`
        <li class="fade">
            ${f.name} <button onclick="deleteFileItem(${f.id},event)" style="float:right;color:red">X</button>
        </li>
    `).join("");
}
function searchFiles(v){
    const fileList=document.getElementById("fileList");
    [...fileList.children].forEach(li=>{
        li.style.display=li.innerText.toLowerCase().includes(v.toLowerCase())?"":"none";
    });
}
async function deleteFileItem(id,e){
    e.stopPropagation();
    if(!confirm("Delete file?")) return;
    await fetch(BASE+"files/"+id,{method:"DELETE"});
    loadFiles();
}

/* ================= FILE POPUP ================= */
async function openFile(id,name){
    currentFileId=id;
    document.getElementById("currentFile").innerText=name;
    const filePopup=document.getElementById("filePopup");
    filePopup.style.display="block";

    const r=await fetch(BASE+"files/"+id);
    const data=await r.json();

    document.getElementById("fileTable").innerHTML=members.map(m=>`
        <tr class="fade">
            <td>${m.name}</td>
            <td><input value="${data[m.id]||''}"></td>
        </tr>
    `).join("");
}
function closePopup(){document.getElementById("filePopup").style.display="none";}
function minPopup(){document.getElementById("filePopup").style.display="none";}
function maxPopup(){document.getElementById("filePopup").classList.toggle("max");}

async function saveFile(){
    const payload={};
    [...document.getElementById("fileTable").querySelectorAll("tr")].forEach((tr,i)=>{
        payload[members[i].id]=tr.querySelector("input").value;
    });
    await fetch(BASE+"files/"+currentFileId,{
        method:"PUT",
        headers:{'Content-Type':'application/json'},
        body:JSON.stringify(payload)
    });
    alert("Saved");
}
async function deleteFile(){
    if(!confirm("Delete file?"))return;
    await fetch(BASE+"files/"+currentFileId,{method:"DELETE"});
    closePopup();
    loadFiles();
}

/* ================= DRAG ================= */
let drag=false,dx,dy;
const popupHeader=document.getElementById("popupHeader");
const filePopup=document.getElementById("filePopup");
popupHeader.onmousedown=e=>{
    drag=true;
    dx=e.clientX-filePopup.offsetLeft;
    dy=e.clientY-filePopup.offsetTop;
};
document.onmousemove=e=>{
    if(drag){
        filePopup.style.left=(e.clientX-dx)+"px";
        filePopup.style.top=(e.clientY-dy)+"px";
    }
};
document.onmouseup=()=>drag=false;

/* ================= INIT ================= */
document.getElementById("memberForm").onsubmit=async e=>{
    e.preventDefault();
    await fetch(BASE+"members",{
        method:"POST",
        headers:{'Content-Type':'application/json'},
        body:JSON.stringify({name:mName.value,phone:mPhone.value})
    });
    e.target.reset();
    loadMembers();
};
document.getElementById("fileForm").onsubmit=async e=>{
    e.preventDefault();
    await fetch(BASE+"files",{
        method:"POST",
        headers:{'Content-Type':'application/json'},
        body:JSON.stringify({name:fileName.value})
    });
    e.target.reset();
    loadFiles();
};

loadMembers();
loadFiles();
</script>
</body>
</html>


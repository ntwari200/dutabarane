<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Admin Dashboard</title>

<style>
* { box-sizing:border-box; font-family:Arial; margin:0; padding:0; }
body { background:#0b0b0b; color:white; }

/* ================= LAYOUT ================= */
h1,h2 { color:#ff2b2b; text-align:center; }
.container {
  max-width:1200px;
  margin:auto;
  padding:15px;
  display:flex;
  flex-wrap:wrap;
  gap:20px;
}
.left-section { flex:1 1 40%; display:flex; flex-direction:column; gap:20px; }
.right-section { flex:1 1 55%; display:flex; flex-direction:column; gap:20px; }

/* ================= CARDS ================= */
.card {
  background:#141414;
  border:2px solid #ff2b2b;
  border-radius:12px;
  padding:15px;
  box-shadow:0 0 12px rgba(255,0,0,.35);
}

input {
  padding:10px;
  margin:6px 0;
  width:100%;
  background:#000;
  border:2px solid #333;
  color:white;
  border-radius:6px;
}

button {
  padding:10px;
  margin-top:8px;
  width:100%;
  background:#ff2b2b;
  border:none;
  color:white;
  border-radius:8px;
  font-weight:bold;
  cursor:pointer;
}

button:hover { background:#ff5555; }

/* ================= INPUT COLORS ================= */
.amount-input { border-color:#00c853; }
.loan-input { border-color:#ff9100; }
.interest-input { border-color:#2979ff; }

/* ================= SMALL DELETE BUTTON ================= */
.btn-delete-small {
  width:32px;
  height:32px;
  padding:0;
  background:#000;
  color:red;
  border:1px solid red;
  border-radius:6px;
  font-weight:bold;
}

/* ================= TABLE ================= */
.table-box { overflow:auto; max-height:320px; }
table { width:100%; border-collapse:collapse; min-width:420px; }
th,td { border:1px solid #333; padding:8px; text-align:center; }
th { background:#ff2b2b; color:black; position:sticky; top:0; }

.search { margin-bottom:10px; }

/* ================= FILE LIST ================= */
#fileList { list-style:none; padding:0; }
#fileList li {
  padding:10px;
  margin:6px 0;
  border:1px solid #ff2b2b;
  border-radius:8px;
  display:flex;
  align-items:center;
  gap:10px;
}
.file-name { flex:1; cursor:pointer; }
.file-name:hover { color:#ff2b2b; }

/* ================= POPUP ================= */
.popup {
  position:fixed;
  top:60px;
  left:50%;
  transform:translateX(-50%);
  width:520px;
  max-width:95%;
  background:#111;
  border:2px solid #ff2b2b;
  border-radius:12px;
  display:none;
  z-index:1000;
}
.popup.max { width:95%; height:95%; top:10px; }

.popup-header {
  background:#ff2b2b;
  color:black;
  padding:10px;
  display:flex;
  justify-content:space-between;
}

.popup-body {
  padding:12px;
  max-height:65vh;
  overflow-y:auto;
}

/* ================= MOBILE ================= */
@media(max-width:768px){
  .container { flex-direction:column; }
  table { min-width:100%; }
  .popup { width:96%; left:2%; transform:none; }
  .popup-body { max-height:75vh; }
}
</style>
</head>

<body>

<div class="container">
<h1 style="flex-basis:100%">ADMIN CONTROL PANEL</h1>

<!-- ================= MEMBERS ================= -->
<div class="left-section">
<div class="card">
<h2>Members</h2>
<input class="search" placeholder="Search..." onkeyup="searchMembers(this.value)">
<form id="memberForm">
<input id="mName" placeholder="Name" required>
<input id="mPhone" placeholder="Phone" required>
<button>Add Member</button>
</form>
<div id="undoArea"></div>
</div>

<div class="card">
<div class="table-box">
<table>
<thead><tr><th>Name</th><th>Phone</th><th>‚ùå</th></tr></thead>
<tbody id="members"></tbody>
</table>
</div>
</div>
</div>

<!-- ================= FILES ================= -->
<div class="right-section">
<div class="card">
<h2>Files</h2>
<input class="search" placeholder="Search file..." onkeyup="searchFiles(this.value)">
<form id="fileForm">
<input id="fileName" placeholder="File name" required>
<button>Create File</button>
</form>
<ul id="fileList"></ul>
</div>
</div>
</div>

<!-- ================= FILE POPUP ================= -->
<div class="popup" id="filePopup">
<div class="popup-header" id="popupHeader">
<b id="currentFile"></b>
<div>
<span onclick="minPopup()">‚ûñ</span>
<span onclick="maxPopup()">‚¨ú</span>
<span onclick="closePopup()">‚ùå</span>
</div>
</div>

<div class="popup-body">

<!-- üîç NEW: MEMBER SEARCH INSIDE FILE -->
<input
  class="search"
  placeholder="Search member in file..."
  onkeyup="searchFileMembers(this.value)"
>

<div class="table-box">
<table>
<thead>
<tr>
<th>Member</th>
<th>Amount</th>
<th>Loan</th>
<th>Interest</th>
</tr>
</thead>
<tbody id="fileTable"></tbody>
</table>
</div>

<button onclick="saveFile()">Save</button>
<button onclick="deleteFile()" style="background:black;color:red">Delete File</button>
</div>
</div>

<script>
const BASE="/api/";
let members=[], files=[], currentFileId=null, lastDeleted=null;

/* ================= MEMBERS ================= */
async function loadMembers(){
  const r=await fetch(BASE+"members");
  members=await r.json();
  renderMembers(members);
}

function renderMembers(data){
  members.innerHTML = data.map(m=>`
    <tr>
      <td>${m.name}</td>
      <td>${m.phone}</td>
      <td><button class="btn-delete-small" onclick="deleteMember(${m.id})">X</button></td>
    </tr>`).join("");
}

function searchMembers(v){
  renderMembers(members.filter(m=>m.name.toLowerCase().includes(v.toLowerCase())));
}

/* ================= FILE MEMBER SEARCH (NEW) ================= */
function searchFileMembers(value){
  value = value.toLowerCase();
  [...fileTable.querySelectorAll("tr")].forEach(tr=>{
    const name = tr.children[0].innerText.toLowerCase();
    tr.style.display = name.includes(value) ? "" : "none";
  });
}

/* ================= FILE POPUP ================= */
async function openFile(id,name){
  currentFileId=id;
  currentFile.innerText=name;
  filePopup.style.display="block";

  const r=await fetch(BASE+"files/"+id);
  const data=await r.json();

  fileTable.innerHTML = members.map(m=>`
    <tr>
      <td>${m.name}</td>
      <td><input class="amount-input" value="${data[m.id]?.amount||''}"></td>
      <td><input class="loan-input" value="${data[m.id]?.loan||''}"></td>
      <td><input class="interest-input" value="${data[m.id]?.interest||''}"></td>
    </tr>
  `).join("");
}

/* ================= SAVE ================= */
async function saveFile(){
  const payload = {};
  [...fileTable.querySelectorAll("tr")].forEach((tr,i)=>{
    payload[members[i].id] = {
      amount: tr.children[1].firstChild.value,
      loan: tr.children[2].firstChild.value,
      interest: tr.children[3].firstChild.value
    };
  });

  await fetch(BASE+"files/"+currentFileId,{
    method:"PUT",
    headers:{'Content-Type':'application/json'},
    body:JSON.stringify(payload)
  });

  alert("Saved");
}

/* ================= INIT ================= */
loadMembers();
loadFiles();
</script>

</body>
</html>
